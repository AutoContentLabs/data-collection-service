services:
  app:
    build:
      context: ../../
      dockerfile: .docker/test/Dockerfile
    volumes:
      - /var/run/docker.sock:/var/run/docker-host.sock
      - ../..:/workspaces/app:cached
    networks:
      - network_test
    depends_on:
      kafka:
        condition: service_healthy
    env_file:
      - .env.${APP_ENV}
    environment:
      APP_ENV: test
      KAFKA_BROKERS: kafka:19092 # Kafka broker connection string for internal docker
    command: "sleep infinity"

  kafka:
    image: apache/kafka-native:3.9.0
    ports:
      - '9092:9092'
      - '9093:9093'
    env_file:
      - .env.${APP_ENV}
    networks:
      - network_test
    healthcheck:
      test: [ "CMD", "sh", "-c", "nc -z localhost 9092" ]
      interval: 30s
      timeout: 5s
      retries: 3
    # environment:
    #   # Kafka environment variables override
    #   # e.g., KAFKA_ADVERTISED_LISTENER, KAFKA_LISTENER_PORT, etc.      

networks:
  network_test:
    driver: bridge
